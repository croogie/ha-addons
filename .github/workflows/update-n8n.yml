# .github/workflows/update-n8n.yml
name: daily-n8n-bump

on:
  schedule:                # every day at 04:15 CET
    - cron:  "40 5 * * *"
  workflow_dispatch:       # manual run

permissions:               # required for PRs from the workflow
  contents: write
  pull-requests: write
  issues: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # tools we need: curl, jq, GNU sed
    - name: install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    # ───── current version in repo ─────
    - id: current
      shell: bash
      run: |
        echo "ver=$(grep '^version:' n8n/config.yaml | cut -d\" -f2)" >> "$GITHUB_OUTPUT"

    # ───── latest upstream stable ─────
    - id: latest
      shell: bash
      env:
        GH_API: https://api.github.com/repos/n8n-io/n8n/releases/latest
      run: |
        # example tag is "v1.94.0" → strip the "v"
        new=$(curl -s $GH_API | jq -r .tag_name | sed 's/^v//')
        echo "ver=$new" >> "$GITHUB_OUTPUT"

    # ───── short-circuit if identical ─────
    - if: steps.latest.outputs.ver == steps.current.outputs.ver
      run: echo "No new n8n release – exiting."

    # ───── patch files ─────
    - name: update files
      if: steps.latest.outputs.ver != steps.current.outputs.ver
      shell: bash
      run: |
        new="${{ steps.latest.outputs.ver }}"
        today=$(date -u +%Y-%m-%d)

        # config.yaml
        sed -Ei "s/^version: \".*\"/version: \"${new}\"/" n8n/config.yaml

        # CHANGELOG.md – insert right after the ## [Unreleased] header
        awk -v v="$new" -v d="$today" '
          NR==1 {print; next}
          /^## \[Unreleased\]/ {
            print $0 ORS;
            print "## [ " v " ] - " d ORS;
            print " Bump n8n to " v ORS;
            next
          }
          1
        ' n8n/CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp n8n/CHANGELOG.md

    # ───── create PR ─────
    - name: pull-request
      if: steps.latest.outputs.ver != steps.current.outputs.ver
      uses: peter-evans/create-pull-request@v6
      with:
        branch: chore/bump-n8n-${{ steps.latest.outputs.ver }}
        title:  "Bump n8n to ${{ steps.latest.outputs.ver }}"
        commit-message: "chore: bump n8n to ${{ steps.latest.outputs.ver }}"
        body: |
          Automated update: n8n **${{ steps.current.outputs.ver }} → ${{ steps.latest.outputs.ver }}**
          * `config.yaml` version field updated
          * `CHANGELOG.md` entry created
        labels: |
          automated
